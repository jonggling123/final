<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ddit.finalproject.team2.professor.dao.KJE_IAssignmentDao">

	<select id="selectLWeekAssignmentProList" parameterType="String"
		resultType="KJE_LWeekAssignmentProVo">
		SELECT
		ASSIGNMENT_NO,
		L.LECTURE_CODE,
		LECTURE_CLASS,
		LECTURE_WEEK,
		L. CLASS_IDENTIFYING_CODE,
		LECTURE_SUBNAME,
		TO_CHAR(ASSIGNMENT_DATE,'YYYY-MM-dd') ASSIGNMENT_DATE,
		TO_CHAR(SUBMIT_PERIOD1,'YYYY-MM-dd') SUBMIT_PERIOD1,
		TO_CHAR(SUBMIT_PERIOD2,'YYYY-MM-dd')SUBMIT_PERIOD2
		FROM
		LECTUREWEEK L
		LEFT OUTER JOIN ASSIGNMENT A ON
		(
		L.CLASS_IDENTIFYING_CODE=A.CLASS_IDENTIFYING_CODE
		AND
		L.LECTURE_CODE=A.LECTURE_CODE )
		WHERE L.LECTURE_CODE =#{lecture_code}
	</select>


	<resultMap type="KJE_AssignmentnFileVo" id="assignmentMap"
		autoMapping="true">
		<id property="assignment_no" column="ASSIGNMENT_NO" />

		<collection property="assignmentFileList" ofType="KJE_AssFileVo"
			autoMapping="true">
			<id property="file_no" column="FILE_NO" />

		</collection>

	</resultMap>

	<select id="selectAssignment" parameterType="String" resultMap="assignmentMap">
		SELECT
		ASSIGNMENT_TITLE,
		TO_CHAR(ASSIGNMENT_DATE,'YYYY-MM-dd')ASSIGNMENT_DATE,
		TO_CHAR(SUBMIT_PERIOD1,'YYYY-MM-dd') SUBMIT_PERIOD1,
		TO_CHAR(SUBMIT_PERIOD2,'YYYY-MM-dd') SUBMIT_PERIOD2,
		CLASS_IDENTIFYING_CODE,
		LECTURE_CODE,
		ASSIGNMENT_CONTENT,
		FILE_NO,
		FILE_PATH,
		FILE_SIZE,
		FILE_NAME,
		A. ASSIGNMENT_NO
		FROM
		ASSIGNMENT A LEFT
		OUTER JOIN ASSIGNMENTFILE F ON(A.ASSIGNMENT_NO=F.ASSIGNMENT_NO)
		WHERE
		A.ASSIGNMENT_NO=#{assignment_no}

	</select>

	<insert id="insertAssignment" parameterType="AssignmentVo">
		<selectKey resultType="string" keyProperty="assignment_no"
			order="BEFORE">
			SELECT ASSIGNMENT_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO ASSIGNMENT (
		ASSIGNMENT_TITLE, ASSIGNMENT_NO,
		ASSIGNMENT_DATE, SUBMIT_PERIOD1,
		SUBMIT_PERIOD2,
		CLASS_IDENTIFYING_CODE,
		LECTURE_CODE, ASSIGNMENT_CONTENT
		) VALUES (
		#{assignment_title}, #{assignment_no},
		SYSDATE, 
		TO_DATE(#{insert_period1}, 'YYYYMMDD'),
		TO_DATE(#{insert_period2}, 'YYYYMMDD'),
		#{class_identifying_code},
		#{lecture_code},
		#{assignment_content, jdbcType=CLOB}
		)
	</insert>

	<insert id="insertAllAssFile" parameterType="KJE_AssignmentnFileVo">
	<selectKey resultType="int" keyProperty="startAssFileNo" order="BEFORE">
		SELECT NVL(MAX(FILE_NO),0)+1 FROM ASSIGNMENTFILE
	</selectKey>

	INSERT ALL
	<foreach collection="assignmentFileList" item="assFile" index="idx">
	INTO ASSIGNMENTFILE (
	FILE_NO, FILE_PATH,
	FILE_SIZE, FILE_NAME,
	ASSIGNMENT_NO
	)VALUES(
	#{startAssFileNo}+#{idx},
	#{assFile.file_path},
	#{assFile.file_size}, #{assFile.file_name},
	#{assignment_no}
	)
	
	</foreach>
	SELECT * FROM DUAL 
</insert>

</mapper>