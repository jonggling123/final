<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ddit.finalproject.team2.student.dao.Ljs_IBoardDao">

	<resultMap type="ddit.finalproject.team2.vo.Ljs_BoardSubjectVo" id="boardListMap" autoMapping="true">
		<id property="board_no" column="BOARD_NO"/>
		<association property="user" autoMapping="true" column="USER_ID" javaType="ddit.finalproject.team2.vo.UserVo" select="ddit.finalproject.team2.common.dao.IUserDao.selectUser"></association>
	</resultMap>
	<select id="selectBoardList" parameterType="string" resultMap="boardListMap">
		SELECT BOARD_NO, BOARD_TYPE, BOARD_DATE, BOARD_TITLE
        , BOARD_HIT, T.USER_ID
		FROM ATTEND T LEFT OUTER JOIN BOARD B
		ON(T.LECTURE_CODE = B.LECTURE_CODE)
		WHERE B.LECTURE_CODE = #{lecture_code}
        ORDER BY DECODE(BOARD_TYPE, 'notice', 1, BOARD_NO, 2), BOARD_NO
	</select>
	
	<resultMap type="ddit.finalproject.team2.vo.Ljs_BoardSubjectVo" id="boardMap" autoMapping="true">
		<id property="board_no" column="BOARD_NO"/>
		<association property="user" autoMapping="true" column="USER_ID" javaType="ddit.finalproject.team2.vo.UserVo" select="ddit.finalproject.team2.common.dao.IUserDao.selectUser"></association>
		<collection property="savedAttachmentList" autoMapping="true" ofType="ddit.finalproject.team2.vo.AttachmentVo">
			<id property="attachment_no" column="ATTACHMENT_NO"/>
		</collection>
	</resultMap>
	
	<select id="selectboard" parameterType="string" resultMap="boardMap">
		SELECT A.BOARD_NO, BOARD_TYPE, BOARD_TITLE, BOARD_DATE
				, BOARD_TITLE, BOARD_HIT, BOARD_CONTENT, A.LECTURE_CODE, A.ATTEND_NO
				, T.USER_ID, B.ATTACHMENT_NO, FILE_NAME, FILE_TYPE
				, FILE_SIZE, FILE_PATH, FILE_ORDER
		FROM BOARD A INNER JOIN ATTEND T
		ON(A.ATTEND_NO = T.ATTEND_NO)
		LEFT OUTER JOIN ATTACHMENT B
		ON(A.BOARD_NO = B.BOARD_NO)
		WHERE A.BOARD_NO IN(
		    TO_NUMBER(#{board_no}),
		    <![CDATA[
		    (SELECT MAX(BOARD_NO) FROM BOARD WHERE BOARD_NO < TO_NUMBER(#{board_no})),
		    (SELECT MIN(BOARD_NO) FROM BOARD WHERE BOARD_NO > TO_NUMBER(#{board_no}))
		    ]]>
		)
		ORDER BY TO_NUMBER(BOARD_NO)
	</select>
	
	<update id="incrementHit" parameterType="string">
		UPDATE BOARD
		SET BOARD_HIT = TO_NUMBER(BOARD_HIT) + 1
		WHERE BOARD_NO = #{board_no}
	</update>
	
	<insert id="insertBoard" parameterType="ddit.finalproject.team2.vo.Ljs_BoardSubjectVo">
		<selectKey resultType="string" keyProperty="board_no" order="BEFORE">
			SELECT TO_CHAR(BO_SEQ.NEXTVAL) FROM DUAL
		</selectKey>
		INSERT INTO BOARD(
			BOARD_NO, BOARD_TYPE, BOARD_ATTACHMENTCOUNT, BOARD_DATE,
            BOARD_TITLE, BOARD_HIT, ATTEND_NO, LECTURE_CODE, BOARD_CONTENT
		)VALUES(
			#{board_no}, #{board_type}, #{board_attachmentcount}, SYSDATE
			, #{board_title}, '0', #{attend_no}, #{lecture_code}, #{board_content}
		)
		
	</insert>
	
	<delete id="deleteBoard" parameterType="string">
		DELETE FROM BOARD WHERE BOARD_NO = #{board_no}
	</delete>
	
	<update id="updateBoard" parameterType="ddit.finalproject.team2.vo.Ljs_BoardSubjectVo">
		UPDATE BOARD
		SET
		BOARD_TITLE = #{board_title}
		, BOARD_DATE = SYSDATE
		, BOARD_CONTENT = #{board_content}
		WHERE BOARD_NO = #{board_no}
	</update>
</mapper>